<!DOCTYPE html>

<style type="text/css">
    html, body {
        width: 100%; height: 95%;
    }
</style>

<html>
<head lang="en">
    <meta charset="UTF-8" />
    <title>Markdown Editor</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.48.4/codemirror.css" />
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/styles/github.min.css" />
    <link
    rel="stylesheet"
    href="https://uicdn.toast.com/tui-color-picker/latest/tui-color-picker.min.css"
    />

</head>
<body>

    <div class="daen-kim" style="position:absolute; right: 90px;">
        <a href="/">
            <img src="https://avatars1.githubusercontent.com/u/41339744?s=400&u=8ab826c81062c6c3d2db3b7cafc0d5d9787d67b8&v=4" style="border-radius: 70%; height: 60px;">
        </a>
    </div>
   
    <div class="tui-logo" style="text-align: center;">
        <br>
        <a href="/toastEditor.html">
            <img src="https://camo.githubusercontent.com/5d5d1faf2493898112ec87f59fcafbc2f8da37b74826df199713d62eb7191fd4/68747470733a2f2f756963646e2e746f6173742e636f6d2f746f61737475692f696d672f7475692d656469746f722d62692e706e67">
        </a>
    </div>

    <br>

    <div class="code-html tui-doc-contents" style="width: 95%; height: 90%; display: block; margin: 0 auto;">
        <div id="editor" style="height: auto;"></div>
    </div>
    
    <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
    <script src="https://uicdn.toast.com/tui-grid/latest/tui-grid.min.js"></script>
    <script src="https://uicdn.toast.com/editor-plugin-code-syntax-highlight/latest/toastui-editor-plugin-code-syntax-highlight-all.min.js"></script>
    <script src="https://uicdn.toast.com/editor-plugin-color-syntax/latest/toastui-editor-plugin-color-syntax.min.js"></script>

    <script>

        var isModified = false;

        function processFile(file) {
            var reader = new FileReader();
            reader.onload = function(event) {
                console.log('File content:', event.target.result);
                editor.setMarkdown(event.target.result);
            };
            reader.readAsText(file);
        }

        const { Editor } = toastui;
        const { codeSyntaxHighlight } = Editor.plugin;
        const { colorSyntax } = Editor.plugin;

        const editor = new toastui.Editor({
            el: document.querySelector('#editor'),
            previewStyle: 'vertical',
            initialEditType: "markdown",
            minHeight: '300px',
            height: '100%',
            plugins: [codeSyntaxHighlight, colorSyntax],
            viewer: true,
            events: {
                change: function ()
                {
                    isModified = true;
                }
            }
        });

        // Using Method: Customize the first button
        const toolbar = editor.getUI().getToolbar();

        editor.eventManager.addEventType('SaveButton');
        editor.eventManager.listen('SaveButton', function() {
            var data = editor.getMarkdown();
                    var mdFile;
                    var downloadLink;

                    if (data == null || data.trim() == "") {
                        alert("입력된 글이 없습니다.");
                        return;
                    }

                    if (!confirm("파일을 다운 받으시겠습니까?")) {
                        alert("취소되었습니다.");
                        return;
                    }

                    var filename = prompt("파일명을 입력해주세요. (기본값 : markdown)");

                    if (filename == null) {
                        alert("취소되었습니다.");
                        return;
                    }

                    if (filename.trim() == "") {
                        filename = "markdown";
                    }

                    // .md 파일을 위한 Blob 만들기
                    mdFile = new Blob([data], {type: "text"})

                    // Download link를 위한 a 엘리먼스 생성
                    downloadLink = document.createElement("a")

                    // 다운받을 md 파일 이름 지정하기
                    downloadLink.download = filename + ".md";

                    // 위에서 만든 blob과 링크를 연결
                    downloadLink.href = window.URL.createObjectURL(mdFile)

                    // 링크가 눈에 보일 필요는 없으니 숨겨줍시다.
                    downloadLink.style.display = "none"

                    // HTML 가장 아래 부분에 링크를 붙여줍시다.
                    document.body.appendChild(downloadLink)

                    // 클릭 이벤트를 발생시켜 실제로 브라우저가 '다운로드'하도록 만들어줍시다.
                    downloadLink.click()
        });

        toolbar.insertItem(0, {
        type: 'button',
        options: {
            className: 'first',
            event: 'SaveButton',
            tooltip: 'Save',
            text: '⇣',
            style: 'background:none; font-weight:bold; color:black;'
        }
        });

        editor.eventManager.addEventType('uploadButton');
        editor.eventManager.listen('uploadButton', function() {
            if (!confirm("기존 내용이 모두 삭제됩니다. 계속 하시겠습니까?")) {
                alert("취소되었습니다.");
                return;
            }

            var input = document.createElement("input");
            input.type = "file";
            input.accept = "text.md"; // 확장자가 xxx, yyy 일때, ".xxx, .yyy"
            input.onchange = function (event) {
                processFile(event.target.files[0]);
            };
            console.log(input);
            input.click();
        });

        toolbar.insertItem(1, {
        type: 'button',
        options: {
            className: 'first',
            event: 'uploadButton',
            tooltip: 'Upload file',
            text: '⇡',
            style: 'background:none; font-weight:bold; color:black;'
        }
        });

        editor.eventManager.addEventType('viewButton');
        editor.eventManager.listen('viewButton', function() {
            var data = editor.getMarkdown();
            console.log(editor.previewStyle);
                    if (editor.getCurrentPreviewStyle() == 'tab') {
                        editor.changePreviewStyle('vertical')
                    }
                    else {
                        editor.changePreviewStyle('tab')
                    }
                    console.log(editor.getCurrentPreviewStyle());
        });

        toolbar.insertItem(2, {
        type: 'button',
        options: {
            className: 'first',
            event: 'viewButton',
            tooltip: 'Change view mode',
            text: '♖',
            style: 'background:none; font-weight:bold; color:black;'
        }
        });

        window.onload = function () {
            editor.setMarkdown(localStorage.getItem("markdown"));
        }

        autoSave = setInterval(function() {
            if (isModified) {
                localStorage.clear;
                localStorage.setItem("markdown", editor.getMarkdown());

                isModified = false;
            }
        }, 5000);

    </script>
</body>
</html>
